name: yiboka

on:
  push:
    branches: [ "master" ]
#    paths: 
#      - 'tc-spider/**'

jobs:
  build:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        shell: bash
    
    strategy:
      matrix:
        node-version: [16.x]

    steps:
    - uses: actions/checkout@v3

    - name: 删除旧的包
      run: sshpass -p ${{secrets.PWD}} ssh -o StrictHostKeyChecking=no ${{secrets.USER}}@${{secrets.IP}} "cd /home/ubuntu && rm -rf yiboka && mkdir yiboka && cd yiboka"

    - name: 压缩
      run: tar -czvf code.tar.gz ./
  
    - name: 上传包和Dockerfile到服务器中
      run: sshpass -p ${{secrets.PWD}} scp -r -o StrictHostKeyChecking=no ./code.tar.gz ${{secrets.USER}}@${{secrets.IP}}:/home/ubuntu/yiboka

    - name: 解压
      run: sshpass -p ${{secrets.PWD}} ssh -o StrictHostKeyChecking=no ${{secrets.USER}}@${{secrets.IP}} "cd /home/ubuntu/yiboka && tar -xzvf code.tar.gz"
  
  check: 
    runs-on: ubuntu-latest
    needs: [build]
    continue-on-error: true
    steps: 
    - name: 测试
      run: ls
    
    - name: 移除已存在compose
      run: sshpass -p ${{secrets.PWD}} ssh -o StrictHostKeyChecking=no ${{secrets.USER}}@${{secrets.IP}} "sudo docker-compose stop yiboka-web1 && sudo docker-compose rm yiboka-web1"

    - name: 移除spider镜像
      run: sshpass -p ${{secrets.PWD}} ssh -o StrictHostKeyChecking=no ${{secrets.USER}}@${{secrets.IP}} "sudo docker rmi yiboka-web"

  deploye: 
    runs-on: ubuntu-latest
    needs: [build, check]
    steps:
    
    - name: 部署
      run: sshpass -p ${{secrets.PWD}} ssh -o StrictHostKeyChecking=no ${{secrets.USER}}@${{secrets.IP}} "cd /home/ubuntu/yiboka && sudo docker-compose -f docker-compose.yml up -d web"
    
